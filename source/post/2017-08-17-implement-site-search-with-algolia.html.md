---
title: Algoliaを利用してサイト内検索機能を実装する
date: 2017-08-17 10:30 JST
image: /images/2017/08/eyecatch-implement-site-search-with-algolia.png
tags:
- Algolia
- JavaScript
- Ruby
- Middleman
- React
- Almin
- DDD
---

こんにちは。  
当ブログのサイト内検索をしたことある方はお気づきかもしれませんが、サイト内検索に[Algolia](https://www.algolia.com/)を利用しています。  
（後述の事情により月初に使えなくなることがたまにありますが）動作速度もかなり早く、安定して稼働してます。  

運用コストもゼロで、記事書いてPRをマージすれば記事公開日に勝手にコンテンツが検索対象に一手間加えてあります。  
Algoliaを１ヶ月実運用してみたので、**Algoliaはいいぞ**という紹介記事を書きたいと思います。  

また、CQRS・DDDの勉強のために、フロントはReactと[Almin](https://github.com/almin/almin)で実装してみました。  
Almin、CQRS、Fluxの小さな実装例の１つとしても参考になるかと思います。

<!--more-->

Algoliaとは
---------------------------------------
https://www.algolia.com/

Algoliaは、検索機能を提供するAPIと管理用APIと公式ライブラリ、そして周辺ツール群にて構成されています。  
私なりの「Algoliaのここがすごい！」は、

* 検索がとにかく早い
* プランが柔軟
* カスタマイズ性が高い
* １ヶ月利用して１回も落ちてない
* 検索APIの気が利いてる
* 自動でタイポの名寄せをしてくれる（NoedをNodeとして解釈可能）
* バックエンド、フロントエンド共にライブラリが充実
* フィールドの重み付けなどのパラメータ調整をコード変えずに対応可能

あたりです。  
大きな導入事例もあり、Alt GoogleSiteSearchのデファクトなのでは！？と思うほどのクオリティと感じています。

DocSearchとは
---------------------------------------
今回はAlgoliaのすごさを全力アピールするため、周辺ツールも紹介します。  
Algoliaが提供する周辺ツールのうち、ぜひ知って欲しいのが[DocSearch](https://community.algolia.com/docsearch/)です。

DocSearchはAlgoliaのコミュニティが提供する、ドキュメンテーションに特化した検索機能用のツールです。  
Algoliaのバックエンドを利用する点は同じですが、**タグを数行書けばサイト内をクローリングして検索対象を自動収集**してくれます。  
今は亡きGoogle Site Searchのような使い勝手で、使い心地はこちらの方が高いと感じました。

> グーグルは、サイト内検索サービスのGoogle Site Searchを2018年に終了することを決定しました。
>
> &mdash; [Google Site Searchが終了へ、サイト内検索は2018年までに他のサービスに乗り換えを | 編集長ブログ―安田英久 | Web担当者Forum](http://web-tan.forum.impressrd.jp/e/2017/03/28/25352)

導入例はかなり強力で、その界隈の開発者にとっては馴染み深いドキュメントで広く活躍してます。
もしかしたらこれらのドキュメントを読んでる過程で、サイト内検索を利用し、Algoliaのロゴに出会ったりしていないでしょうか。

* [ReactNative](https://facebook.github.io/react-native/)
* [Babel](https://babeljs.io/)
* [Middleman](https://middlemanapp.com/basics/install/)
* [Vue.js](http://vuejs.org/v2/guide/)
* [Scala](http://docs.scala-lang.org/)

なお、今回は自前で実装してAlmin、DDD、CQRSについて実践したかったので、DocSearchではなくAlgoliaを利用しています。

Algoliaの導入例
---------------------------------------
周辺ツールの１つであるDocSearchに話が逸れましたが、Algolia本家の話に戻します。

先述の通りAlgoliaは一部開発者にとっては馴染み深いドキュメントで利用されていますが、  
他にも有名なWebサービスでも利用されているようです。

* [Twitch](https://www.twitch.tv/)
* [Periscope](https://www.pscp.tv/)
* [Stripe](https://stripe.com/jp)

DocSearchのように、だいたいサイト内検索系のサービスの対象は静的サイトだと思いますが、  
Algoliaが恐ろしいのは**動的なWebサービスでも利用されている**という点です。  
それもAmazon(Twitch)やTwitter(Periscope)などすでに巨大な検索エンジンを持ってそうな企業が採用している点は脅威です。

自分で使ってみても、それくらい検索性・速度の面で圧倒的に良いと思いますし、  
何より、複雑になりがちな検索機能のクエリ処理を実装しなくていいというのはかなりのアドバンテージなのではないでしょうか。  
試してはないですが、AlgoliaはバックエンドのAPIがかなり整っているので、動的サイトでも大きな遅延なく検索機能を代替できそうなイメージがあります。

Algoliaの料金・制限
---------------------------------------
[Algoliaの料金ページ](https://www.algolia.com/pricing)

Algoliaは無料で始められます。  
また、小規模なサイトであれば無料のまま使い続けられます。

* 検索対象になるマスタデータ1万件まで
  * 当ブログに置き換えると1万記事までOK
* Algolia APIを月10万回まで実行可能
  * 記事の登録も1回、記事の検索も1回

で用途として足りていれば、無料のまま継続利用できます。  
月10万回というのがとても絶妙な数でして、月1万PVほどの当ブログで1ヶ月試した結果、ギリギリアウトでした。（残３日にて回数上限オーバー）  
なお、**上限オーバーすると、検索もコンテンツの追加もできなくなります。**

![上限超えた時の図](/images/2017/08/algolia-search-limit-exceeded.png)

このブログにおいて検索はさほどクリティカルな機能ではないし、無料で提供しているので、まぁ数日くらい検索できなくてもいいやくらいの温度感でやってます。  
もしプラン上げたくなったら、管理画面から手続きすればプランの分だけ上限は復活するので、最悪そうします。

概要、メリット、費用面について整理できたので早速Algoliaで検索機能の実装を始めます

記事をJSON化してAlgoliaに登録する
---------------------------------------

検索機能を実装する
---------------------------------------

開発環境と本番環境でAlgoliaのインデックスを分ける
---------------------------------------

記事を書いたら自動でAlgoliaにコンテンツが登録されるようにする
---------------------------------------

Alminとは
---------------------------------------

検索機能をAlminとDDDと
---------------------------------------

まとめ
---------------------------------------

すごいぞAlgolia、すごいぞAlmin！！
