---
title: JavaScriptのDateで現地時刻を復元しようとしてとことんハマった
date: 2018-12-01 10:30 JST
tags:
- JavaScript
- Date
---

tl;dr
----------------------------------------------------------------
- Date#toISOString()は実行時のタイムゾーンに関わらず常にUTCでの文字列を返す
- Date#toISOString()に頼ったUTC文字列、UNIXタイムスタンプ「だけ」を保存していると現地時刻へ戻せなくなる
- DateコンストラクタはISO8601形式においても実装依存なので気を抜かないこと

今回の記事は、「UTC時刻を現地時間に戻さないといけない要件」があるからハマったことである。  
「現地時間に戻して演算」という要件がないのであれば、この記事のハマりポイントは多くの場合出現しないと思われる。

UTC時刻やUNIXタイムスタンプ（エポック秒）
----------------------------------------------------------------

UNIXタイムスタンプ（エポック秒）

やりたいこと：現地時間で計算する
----------------------------------------------------------------
例えばユーザに対してタイムゾーンを持たせるようなアプローチもあると思うが、今回の要件では

- ユーザが海外旅行へ行き、海外でアプリを操作した
- 日本に戻ってきても現地での時刻として計算できること
- 引き続き日本でアプリを利用しても日本時間として計算できること

つまり１レコード単位で記録されているタイムゾーンが変化しうる、１レコード単位で現地時刻へ戻せる必要があるという要件です。
そのため例えば「ユーザ単位でタイムゾーン設定を持たせ、設定タイムゾーン以外の地域ではバグる」が許容されません。

Date#toISOString()とISO8601
----------------------------------------------------------------

Date#getTimezoneOffset()とサマータイム
----------------------------------------------------------------

date-fnsのフォーマット関数
----------------------------------------------------------------
（v2が策定されておりこの辺りのパターン激変するカモよ）

実行環境のタイムゾーンとISO8601のタイムゾーン指定子
----------------------------------------------------------------

現地時刻を復元する
----------------------------------------------------------------

データとして何を保持すべきなのか
----------------------------------------------------------------

ISO8601のタイムゾーン指定子は`(+|-)hhmm`ではなく`(+|-)hh:mm`にすべき
----------------------------------------------------------------
Node.jsとChromeでひとしきりテストをし、油断しきっていた。
それは、iOS Safariで起こった。

おまけ：１プロセス内でタイムゾーンを変えてテストしたい
----------------------------------------------------------------
