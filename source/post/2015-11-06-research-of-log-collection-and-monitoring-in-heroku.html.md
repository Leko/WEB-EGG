---
path: /post/research-of-log-collection-and-monitoring-in-heroku/
title: Herokuでのログ収集と監視について調べてみた
date: 2015-11-06T12:30:16+00:00
dsq_thread_id:
  - "4292918550"
meaningless:
  - "yes"
twitter_id:
  - "662472497065922561"
categories:
  - やってみた
tags:
  - fluentd
  - Go
  - Heroku
  - Papertrail
  - TreasureData
---

こんにちは。  
Go に入門してからは Heroku に Go のアプリをデプロイするようになり、それをきっかけに Heroku について調べる機会が多くなりました。

今回は Heroku でログ収集＋監視をする方法について調べてみました。  
単にログを見るだけなら`heroku logs`コマンドで十分なのですが、特定のログが吐かれた時や、高負荷時などを検知して携帯に通知できるような仕組みを探してみたので備忘録を残します。

<!--more-->

## 結論

[Papertrail](https://papertrailapp.com/?thank=15fc38)を採用しました。  
以下に調査の詳細を書いていきます。

## 作っているものの要件

- 1000~10000 リクエスト/日 程度の小さな API サーバ
- 言語は Go、WAF は[gin](https://github.com/gin-gonic/gin)で実装
- **趣味プロダクト** でサーバの管理したくないので Heroku にデプロイ

趣味プロダクトなら、という目線で見ているので業務レベルでの選定はしてません。悪しからず。

## ログ収集＋監視に求めるもの

調べるにあたってログ収集に求めていたものは以下でした。

- 基本無料 + お手頃な有料プランが有ること
- ソースコードに影響しない
- 導入が簡単
- 通知機能

**基本無料**を求めるのは、開発環境にお金を払いたくないから。  
性能はしょぼくてもいいので動いてくれること。本番と開発用で違うプラグイン使ったり、環境判定のコードなどを混ぜたくないためです。  
あわせて **お手頃な有料プラン** も求めているのは、本番環境ではお金を払うためです。  
もちろん無料でも十分な性能ならぜひ利用したいですが、無料にこだわっているわけではないので。でも、有料プランの最低料金の障壁があまりに高いと、少し財布の紐が硬くなってしまいます。  
要約すると **「小さく初めて必要性がでたらプランを上げる」** ことができるステップが存在することを求めています。

次に **ソースコードに影響しない** は、バグリスクの削減と、プログラムの動作速度を可能な限り早めるためです。  
ソース内でどこぞのサーバと通信したりなんだり、ということをしてしまうと遅いってレベルじゃなくなってしまうので論外です。  
**アプリケーションサーバはあくまで標準(エラー)出力 or ログファイルに出力するだけ** 。  
それを受け取った Heroku のログを見てくれるものを探しています。

**導入が簡単** なのは言うまでもなく<del>面倒</del>複雑さを減らし、ドハマりやエッジケースでにっちもさっちもいかなくなることを防いで丸く納めるためです。

**通知機能** をログ収集サーバがすべきかについては諸説ありますが、今回の要件なら本格的なサーバの監視をするわけではないので、まぁログサーバ側で見ればいいよね、といった感じです。  
**「特定のログが吐かれたら＊＊、なるべくリアルタイムで監視＋通知の自由度が高い」** ものを求めています。  
ここはちょっと欲が出ているので、最悪無くてもいいやと思って探しました。

## 調べたものと概要

調べて・試してみた情報と、その概要です。

### 断念: Log drain + ホスティング

- Heroku のログを他サーバに垂れ流せる機能
- Heroku 使ってんのにログサーバを自前で管理しなきゃいけない
- いいホスティングサービスが見つからなかった

### 断念: TreasureData + fluentd

- 14 日の無料体験アカウント＋その後有料

### 断念: Bonsai.io + Elasticsearch + Kibana

- 最低でも有料

### 断念: Mackerel

- [ドキュメント](http://help-ja.mackerel.io/entry/advanced/monitoring-heroku)が丁寧にかかれているのですが、<del>めんどくせ</del>と思ってしまい断念

### 採用: [Papertrail](https://papertrailapp.com/?thank=15fc38)

- いい感じ

1 つずつ詳細を書きたいと思います。

## 断念: Log drain + ホスティング

Heroku には[Log Drains](https://devcenter.heroku.com/articles/log-drains)という機能があります。

> Logplex のドレイン（外部への排出機能）は、Heroku のログを外部のシステムログ管理用サーバーへ長期間アーカイブするために、転送することを許可しています。Heroku のシステムログのパケットを取得可能とするためには、Logplex のドレイン、またはシステムログ管理用サーバー自体を設定する必要があります。この設定の後で、システムログの URL（ホスト名とポート番号を含む）をドレインとして追加する必要があります。  
> ドレインするログは、 RFC5424 に沿ってフォーマットされます。これらは RFC6587 で説明される TCP プロトコルと octet counting framing method を経由し伝達されます。  
> ログ監視系のサービスを見つけるには、Heroku アドオンを訪問して下さい。  
> &mdash; [システムログを外部へドレイン（排出）する](https://github.com/herokaijp/devcenter/wiki/logging#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%83%AD%E3%82%B0%E3%82%92%E5%A4%96%E9%83%A8%E3%81%B8%E3%83%89%E3%83%AC%E3%82%A4%E3%83%B3%E6%8E%92%E5%87%BA%E3%81%99%E3%82%8B)

邦訳記事に感謝します。  
ということで、 **ドレインの機能を使用してログをどこかしらのサーバへ垂れ流せばよいのでは？** という過程で調査をすすめていきました。  
ログサーバを自前でホスティングすれば Fluentd+Elasticsearch+Kibana だったり BigQuery だったりと何でもやれますが、Heroku にしたきっかけが自分でサーバを持ちたくないことなので、本末転倒になってしまうため選外としました。

> [Heroku アプリのログを fluentd で ElasticSearch に突っ込んで Kibana で監視する方法 – hakobera's blog](http://hakobera.hatenablog.com/entry/2014/02/03/122029)

## 断念: TreasureData + fluentd

ログの収集や解析を調べているとだいたいセットで出てくる「fluentd」、実際に使ったことが無いのでなんとなく概要しか知らないのですが、これを期に使ってみようかと思いました。

ということで「heroku fluentd」と調べてみたところ、fluentd を制作していらっしゃる[TreasureData さんの記事](http://docs.fluentd.org/articles/install-on-heroku)が見つかりました。

だがしかし TreasureData のアカウントが必要。 しかも TreasureData のアカウントは 14 日間のフリートライアル。その後は、、、調べてもわからなかったので資料請求してみましたが、それでも料金プランなどの記載はありませんでした。

ものすごく高機能で高性能で高精度で、名だたる企業さんも導入していたりといい事尽くしですが、 **これだけ色々できて有名なサービスで値段調べても出てこないなら toB 向けで、かつ安いわけない** 。と勝手に推測し、残念ながら趣味プロダクトの身の丈には合わないと判断して断念しました。

> こちらの記事も参考になりました。  
> [TreasureData – 世界最速で Fluentd を立ち上げる on Heroku – Qiita](http://qiita.com/kiyoto/items/24e15ac38804ca48b06d)

## 断念: [Bonsai.io](https://bonsai.io) + Elasticsearch + Kibana

「Kibana hosting」と調べたら偶然出てきたサービスです。  
Elasticsearch のクラスタリング、Kibana のホスティングあたりをまるっと提供してくれる粋なサービスです。  
[Heroku のアドオンもあった](https://elements.heroku.com/addons/bonsai)ので見てみたところ、 **残念ながら最低でも 10$/m** 。  
月千円くらいええやんケチ と自分に突っ込んでしまいましたが、まだ妥協するには早い。他に選択肢がなければ 1000 円払おう。と考えつつ、保留しました。

※結果としては後述の[Papertrail](https://papertrailapp.com/?thank=15fc38)を採用したので見送りになりました。

## 断念: Mackerel

[ドキュメント](http://help-ja.mackerel.io/entry/advanced/monitoring-heroku)が丁寧に書かれていて大変申し訳無いのですが、設定手順長い。めんどくさい。と思ってしまいました。

Mackerel の料金的には無料でもある程度使えるし有料プランも月 2000 円と悪くないお手軽さなのですが、この高機能さが必要になったら求めてみようと思います。今回は断念。

## 採用: [Papertrail](https://papertrailapp.com/?thank=15fc38)

採用しました。まさに条件ピッタリなサービスでした。  
最初にログドレインについて調べていたので、Heroku のアドオン検索画面で「drain」と調べたら偶然ヒットしました。

Fluentd, Elasticsearch, Kibana などのナウい感じではないですが、 **ちょうど趣味プロダクトのスケール感に合いそうでちょいど良い** と最も感じたサービスです。

このサービス通知機能が協力で、ログをフィルタして、`n`分間に`m`行以上マッチするログが出現したら`**`する、という設定ができます。  
通知の方法も豊富で、Slack や HipChat、Zapier や Pushover、更にはメール通知や WebHook も使えるのでもはや何でもありです。

[Heroku のアドオンも基本無料、次が 7$](https://elements.heroku.com/addons/papertrail)とお手軽感満載。

Heroku でよく出るログはあらかじめフィルタとして登録しておいてくれるし、なんだこの優しさは。初心者向けとはこういうことを言うんだと感動するちょうど良さでした。  
ログが収集されるまでのラグも 3~10 秒くらいなので速くはないですが、余裕の許容範囲内です。

ログのアーカイブを S3 に転送できたり、サービスで保持できるログ容量の拡張も細かくできるので、いざとなれば札束で殴ることができそうです。  
また、Heroku で自動的に吐かれてしまうログを収集しないようにすることもできるので、ケチろうと思えばケチれるという幅の広さも魅力の一つだと思います。

導入も最初手間取りましたが必要な手順は少なく、通知の設定も簡単です。  
導入にあたり下記の２記事が参考になりました。ありがとうございます。

> &mdash; [heroku のログ管理は Papertrail がいい感じ – Oh! My! Enter! ～バッチを起動しようと勢いよくキーを叩いたら、それはシフトキーだった～](http://d.hatena.ne.jp/itmammoth/20130729/1375112798)  
> &mdash; [heroku に papertrail を導入して、アラートを hubot 経由で slack へ通知する](http://qiita.com/yukofeb/items/f7c0b4f9bdc11a9daf40)

デフォルトでついてるデプロイのログと、Dyno のステータスが変わった時のログ、あとアプリケーションのログであるキーワードに引っかかるログが 1 時間に 1000 行以上出たら要警戒、それぞれを Slack に通知するように Alert の設定を行いました。  
要警戒と言いつつ、特に何もやばくないんですが今後アプリケーションログを監視するなら事前に試しておきたいので設定してみた次第です。  
Slack が私の携帯に入っているので、これでわざわざログを見に行かなくても、しかるべきタイミングでメッセージ（を通知する push 通知）が届きアラートとして使用できそうです。  
Heroku がデフォルトでアクセスログも残してくれており、Papertrail もそれを収集・フィルタできるので、落ち着いたタイミングでアクセスログの解析などもできそうです。

## まとめ

色々と試してみましたが、ホットな話題には触れられない結果に終わりました。  
代わりにバズ Word に惑わされず自分の要件に合うものを探し続けたら見つかったので、その点何かを探す時のモチベーションにしたいなと思いました。

もしこの記事を読んでいて同じような悩みを抱えてる方がいらっしゃいましたら[Papertrail](https://papertrailapp.com/?thank=15fc38)を使ってみると良いと思います。
