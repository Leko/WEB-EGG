---
path: /post/automate-cookie-clicker-with-js/
title: CookieClikerをjsから操作してみる
date: 2013-09-21T22:25:19+00:00
twitter_id:
  - "381414926868164608"
dsq_thread_id:
  - "3132443056"
image: /images/2013/09/20130921_cookie1.jpg
categories:
  - やってみた
tags:
  - JavaScript
---

久しぶりの更新です。

最近、Twitter の一部界隈で[Cookie Clicker](http://orteil.dashnet.org/cookieclicker/)というゲームが流行っているようです。  
ゲームのパロディ、**ヒロイン※の官能小説**なども出るほど、日本で人気なようです。

そんなに面白いのかと思ってページを開いてみたら、  
**ただ Cookie を焼くだけのブラウザゲー**でした。

**わけがわからん…。**  
おもむろに左側に表示されている Cookie を右クリックして「要素を検証」してみたところ、

```html
<div id="bigCookie"…
```

**あ、これはいけるわ。**  
と思って js を書いてクリック連打を実装しましたが、  
思ったよりもこのゲーム一筋縄では行かないことが分かり、**ハマってしまいました。**

ただ Cookie を増やすだけでなく、**放っておくだけで実績全解除が出来る**ような js  
を目指してみたいと思います。

※おばあさんです

<!--more-->

## 対応ブラウザ

Chrome 最新版、Safari 最新版、Firefox 最新版で動作確認しました。  
おそらく、`document.querySelector()`が使えるブラウザなら大丈夫です。

普段使っているブラウザが Chrome なので、記事では Chrome で説明をしていきます。  
他ブラウザをお使いの方は、適宜読み替えて下さい。

## 自作の js をページ内で実行するには

普段 JavaScript を書いている方ならご存知かと思いますが、  
ブラウザのコンソールは、現在のページに対して任意の js を実行することが出来ます。

まず、  
Chrome の`メニュー > 開発/管理 > JavaScriptコンソール`をクリックします。  
ショートカットは、`⌘+Shift+j`です。

試しに２つほど js を流し込んでみます。

![流し込んだjs](/images/2013/09/2e351d28a49190b1d0cfb8e88191406a.png)

このページで定義されているグローバルな変数にもアクセスできるので、  
**CookieClicker のゲームを司る Game オブジェクトにもアクセス出来るし、書き換えられます**。

ただし、ゲームの設定値や挙動自体を変えてしまうのはチートやであって、  
**自動制御**という名目から離れているので、  
あくまで、**ユーザ操作で出来る範囲内の行動しか取らない方針**で行きます。

行動の最適化はかけていないので、**にわか TAS**みたいな感じと思ってもらえればと思います。

## 制御に必要な要素を取得する

まず、ゲームの進行に必要な要素を js から制御できるよう抑えていきます。

このゲームでは、**jQuery が読み込まれていない**らしく、`$()`が使えません。  
`jQuery`も undefined です。

なので、要素の取得は、お手軽に`document.querySelectorAll`を使っていきます。  
CSS のセレクタを使って要素を取得できる組み込みメソッドです。

### Cookie

セレクタ：`#bigCookie`

画面左側にあるクリックする Cookie です。  
自動制御ならではの高速連打は、Cookie 生産量に大きく影響します。

### ビルディング

セレクタ：`#products .product`

ビルディングの一覧が取得できます。  
この子らを買わないと実績も生産も何もないので必須です。

### アップグレードアイテム

セレクタ：`#upgrades .upgrade`

ビルディングの強化や、クリック性能の強化等のアイテムが買えます。  
これらを買っていくことでどんどん Cookie 生産効率が上がっていきます。  
実績の解放にも必要です。

### ゴールデン Cookie

セレクタ：`#goldenCookie`

何分かに１度ほど出現し、クリックすると良いことが起こる Cookie です。  
生産効率の上昇や、実績の解放に関わるしデメリットが無いので抑えておきます。

### ニュース

セレクタ：`#commentsText`

画面上部の中央に表示されているニュースです。  
いくら自動制御といえど、このゲームの世界観は楽しみたいものです。  
実績には関係ないのでこれは必須ではありません。

## 基本的な処理

自動制御するからには、**１度実行したらあとは放置**で居たいものです。 そして、ゲームの設定をうっかり書き換えてしまうのも怖いので**グローバルは使いたくありません**。 さらに、毎回クエリをかけるわけにもいかないので、DOM はキャッシュしておきたいです。

ということで、`即時関数`と`setInterval`を使います。  
リピートの間隔は、適当に設定して下さい。

```javascript
!function() { // 長いので省略 var qs = function(selector) { document.querySelectorAll(selector); }; var FPS = 500, // 1秒で処理を実行する回数 upgrades = qs("#upgrades .upgrade"), products = qs("#products .product"), cookie = qs("#bigCookie"), golden = qs("#goldenCookie"); setInterval(function() { // ここに操作を追加 }, 1000 / FPS); }();
```

基本的な枠組みはこんな感じになると思います。

次に、jQuery が無いので、いくつか汎用関数を作っていきます。  
jQuery を js から読み込ませることも出来るのですが、大した処理もないのでやりません。

繰り返しを行う`each`、  
指定した要素が特定のクラスを持っているか調べる`hasClass`を定義しました

```javascript
var each = function(arr, fn) {
    for (var i = 0; i < arr.length; i++) {
      fn.call(arr[i], arr[i], i);
    }
  },
  hasClass = function(el, className) {
    return el.classList.contains(className);
  };
```

こんな感じです。 これ以降の処理は、特に記述がない限り setInterval の中の関数に書いていきます。

### Cookie・ゴールデン Cookie をクリック

まず、Cookie をクリックさせてみます。  
クリックイベントを発生させるには、`onclick`メソッドが使えます。

ゴールデン Cookie も同様に、**出現してようとなかろうとひたすら連打**です。

```javascript
cookie.onclick();
golden.onclick();
```

これだけです。設定した FPS 分だけ Cookie がクリックされます。 ゴールデン Cookie は出現した瞬間にクリックされるので全く見えません。笑

### ビルディング・アップグレードを買う

アイテムを買うのも同様に`onclick()`で買えます。  
**値段が足りようと足りなかろうと onclick()してしまって問題ない**のですが、

個人的にあまり好みではありません。  
**ゴールデン Cookie 連打しておいて何を言ってるんだお前は**という話ですが。笑 ということで先ほど定義した`hasClass`を利用します。

購入可能なアイテムには`enabled`というクラスが付くので、  
アイテムを順に見て行き、**enabled クラスを持っていたら購入**という処理にします。 値段が足りるものを手当たり次第買っていきます。

同様に、each の第１引数を upgrades にするだけで、アップグレードも同様に買えます。

```javascript
each(products, function(el) {
  if (hasClass(el, "enabled")) {
    el.onclick();
  }
});
each(upgrades, function(el) {
  if (hasClass(el, "enabled")) {
    el.onclick();
  }
});
```

ここはお好みで。

## これでは詰まる

しかし、これですんなり行くなら苦労しません。

このゲーム、ビルディングの価格バランスがだいぶ極端なので、  
**買えるけど買わない処理**を挟まないと、ビルディングの所持数に激しく偏りが出ます。 農場や工場など、買ってもしょうがないものは、**必要最低限しか要りません**。

ビルディング所持数に関連した、実績解放のためには

- 指：200 個
- おばあさん：128 個
- その他：100 個

を所持する必要があります。  
ということで、ビルディングの購入ロジックを少し変えます。

まず、購入する数を制御する配列を FPS の下あたりに定義しておきます。

```javascript
// 全ビルディングを10個ずつ, 50個ずつ、と買い揃えていく var BUY_STEPS = [10, 50, 100, 128, Number.MAX_VALUE]; // 所持数を取得するメソッドを定義 var getOwnedCnt = function(el) { var cnt = el.childNodes[1].childNodes[2]; return cnt ? +cnt.textContent : 0; }
```

次に、each の部分を書き換えます。

```javascript
var nextStep = true;
each(products, function(el) {
  var buyCnt = getOwnedCnt(el);
  if (hasClass(el, "enabled") && buyCnt < BUY_STEPS[0]) {
    el.onclick();
  }
  nextStep = nextStep && buyCnt >= BUY_STEPS[0];
});
if (nextStep) BUY_STEPS.shift();
```

アイテムを単に買い揃えていくことが最適な行動ではないのですが、  
あまり細かいロジック考えるのも面倒なので、思考停止です。

これで、**値段が足りていても既に必要分所持している場合には買わない**ことが可能になります。

少ない数であれば、高ランクのものも比較的容易に手に入るので、  
タイムマシン、コンデンサあたりを早めに確保し、序盤の生産効率を上昇させています。

## 特殊な処理

これでしばらく運用していたのですが、自動制御の敵がまた現れました。

### 購入確認ダイアログ

ビンゴセンター・研究所を購入すると出るアイテムのいくつかが、 購入前に、**「購入しますか？」という確認ダイアログ**が出ます。

確認ダイアログの`window.confirm`は、  
ユーザの選択が[はい]なら`true`、[いいえ]なら`false`を返す実装になっています。

ダイアログを操作するより、**関数の動作を変える方が楽なので、上書き**します。

```javascript
window.confirm = function() {
  return true;
};
```

これで、ダイアログは出ず、強制的に"はい"が選択されたことになります。  
js の処理を止めるのはこいつだけなので、ここさえ超えてしまえばあとは放って置くだけです。

### 実績：NeverClick

隠れ実績として「Never Click」という実績があります。  
これは、「１度も Cookie をクリックせずに 100 万 Cookie 生産する」ことが条件なのですが、

先ほどの記述だと、無条件に Cookie を連打してしまいます。  
**およそ 0.03 秒で条件失敗です。**

ただし、ゴールデン Cookie のクリック数は条件に含まれないようです。

ということで、隠し称号を取るのであれば、  
Cookie.onclick()の行をコメントアウトして下さい。 ゴールデン Cookie とアイテム購入で稼いでいきます。

## 最後に

今回は重いきり無駄遣いをしていましたが、

「この jQuery セレクタで合ってる？」なんて時にコンソールでサクッと書くのが良かったりします。 普通に、js のデバッグをする際にも使えるので、コンソールから入力する js、使ってみて下さい。

最終的に、自分が実績全解放までに使った js は、以下のようになりました。  
１週目のプレイでは`DONT_BUY_ELDER`を false にしてあげて、  
頃合いを見てリセットが必要になります。そこまでの自動化は、また後々ということで。
